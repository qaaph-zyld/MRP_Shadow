<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Analysis Dashboard</title>
    <!-- Include Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Include PapaParse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <!-- Include Bootstrap for styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        .chart-container {
            position: relative;
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 15px;
            background-color: white;
        }
        .filters {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
        }
        .data-table {
            margin-top: 30px;
            max-height: 400px;
            overflow-y: auto;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            font-weight: bold;
            background-color: #f0f0f0;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #0d6efd;
        }
        .metric-label {
            font-size: 14px;
            color: #6c757d;
        }
        .btn-primary {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        .btn-outline-secondary {
            color: #6c757d;
            border-color: #6c757d;
        }
        .table-container {
            overflow-x: auto;
        }
        #fileUpload {
            display: none;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <h1 class="mb-4">Inventory Analysis Dashboard</h1>
        
        <div class="alert alert-info" role="alert">
            <h4 class="alert-heading">Welcome to the Inventory Analysis Dashboard!</h4>
            <p>This dashboard automatically loads and visualizes inventory data from the Inventory_per_Project.sql query results.</p>
            <hr>
            <p class="mb-0">Use the filters to narrow down the data and focus on specific projects, plants, or inventory categories.</p>
        </div>

        <!-- Data Source Section -->
        <div class="card mb-4">
            <div class="card-header">
                Data Source
            </div>
            <div class="card-body">
                <p>Data is automatically loaded from the latest Inventory_per_Project.sql query results.</p>
                <div class="input-group">
                    <input type="text" class="form-control" id="dataPath" value="../output/inventory_per_project_results.csv" readonly>
                    <button class="btn btn-primary" id="refreshDataBtn">Refresh Data</button>
                    <input type="file" class="form-control" id="fileUpload" accept=".csv">
                    <label for="fileUpload" class="btn btn-outline-secondary">
                        Use Different File
                    </label>
                </div>
                <div id="fileInfo" class="mt-2 text-muted"></div>
            </div>
        </div>

        <!-- Loading indicator -->
        <div id="loadingIndicator" class="text-center my-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading and processing data...</p>
        </div>

        <!-- Dashboard content (hidden until data is loaded) -->
        <div id="dashboardContent" class="d-none">
            <!-- Filters Section -->
            <div class="filters">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label for="plantFilter" class="form-label">Plant</label>
                        <select class="form-select" id="plantFilter">
                            <option value="all">All Plants</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="projectFilter" class="form-label">Project</label>
                        <select class="form-select" id="projectFilter">
                            <option value="all">All Projects</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="categoryFilter" class="form-label">Category</label>
                        <select class="form-select" id="categoryFilter">
                            <option value="all">All Categories</option>
                            <option value="FG">Finished Goods</option>
                            <option value="SFG">Semi-Finished Goods</option>
                            <option value="RM">Raw Materials</option>
                            <option value="No BOM">No BOM</option>
                        </select>
                    </div>
                    <div class="col-md-3 mb-3">
                        <label for="groupFilter" class="form-label">Group</label>
                        <select class="form-select" id="groupFilter">
                            <option value="all">All Groups</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <button id="applyFilters" class="btn btn-primary">Apply Filters</button>
                        <button id="resetFilters" class="btn btn-outline-secondary ms-2">Reset Filters</button>
                    </div>
                </div>
            </div>

            <!-- Key Metrics Section -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <div class="metric-label">Total Inventory Value</div>
                            <div class="metric-value" id="totalInventoryValue">$0</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <div class="metric-label">WIP Value</div>
                            <div class="metric-value" id="wipValue">$0</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <div class="metric-label">Warehouse Value</div>
                            <div class="metric-value" id="whValue">$0</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <div class="metric-label">Item Count</div>
                            <div class="metric-value" id="itemCount">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="chart-container">
                        <h5>Inventory Value by Category</h5>
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="chart-container">
                        <h5>Inventory Value by Project</h5>
                        <canvas id="projectChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="chart-container">
                        <h5>Inventory Distribution by Location</h5>
                        <canvas id="locationChart"></canvas>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="chart-container">
                        <h5>Top 10 Items by Value</h5>
                        <canvas id="topItemsChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Data Table Section -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Detailed Data</span>
                    <button id="exportBtn" class="btn btn-sm btn-outline-primary">Export to CSV</button>
                </div>
                <div class="card-body table-container">
                    <table class="table table-striped table-hover" id="dataTable">
                        <thead>
                            <tr>
                                <th>Plant</th>
                                <th>Project</th>
                                <th>Category</th>
                                <th>Item Number</th>
                                <th>Description</th>
                                <th>WIP Qty</th>
                                <th>WH Qty</th>
                                <th>WIP Value</th>
                                <th>WH Value</th>
                                <th>Total Value</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                    <div id="paginationControls" class="d-flex justify-content-between align-items-center mt-3">
                        <div>
                            <span id="pageInfo">Showing 0-0 of 0 items</span>
                        </div>
                        <div>
                            <button id="prevPage" class="btn btn-sm btn-outline-secondary">Previous</button>
                            <button id="nextPage" class="btn btn-sm btn-outline-secondary ms-2">Next</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let rawData = [];
        let filteredData = [];
        let currentPage = 1;
        let rowsPerPage = 10;
        let charts = {
            categoryChart: null,
            projectChart: null,
            locationChart: null,
            topItemsChart: null
        };
        
        // Default data path
        const defaultDataPath = '../output/inventory_per_project_results.csv';
        
        // Document ready
        document.addEventListener('DOMContentLoaded', function() {
            // Try to load data automatically
            loadDefaultData();
            
            // Event listeners
            document.getElementById('refreshDataBtn').addEventListener('click', loadDefaultData);
            document.getElementById('fileUpload').addEventListener('change', handleFileSelect);
            document.getElementById('applyFilters').addEventListener('click', applyFilters);
            document.getElementById('resetFilters').addEventListener('click', resetFilters);
            document.getElementById('exportBtn').addEventListener('click', exportToCSV);
            document.getElementById('prevPage').addEventListener('click', () => navigateToPage(currentPage - 1));
            document.getElementById('nextPage').addEventListener('click', () => navigateToPage(currentPage + 1));
        });
        
        // Load default data
        function loadDefaultData() {
            document.getElementById('loadingIndicator').classList.remove('d-none');
            document.getElementById('dashboardContent').classList.add('d-none');
            
            // Use PapaParse to load the CSV file
            Papa.parse(defaultDataPath, {
                download: true,
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.data && results.data.length > 0) {
                        rawData = results.data;
                        initializeDashboard();
                    } else {
                        showError("No data found or file is empty.");
                    }
                },
                error: function(error) {
                    console.error("Error loading data:", error);
                    showError("Failed to load data. Please check if the file exists and try again.");
                    
                    // Show file upload option as fallback
                    document.getElementById('fileUpload').style.display = 'block';
                }
            });
        }
        
        // Show error message
        function showError(message) {
            document.getElementById('loadingIndicator').classList.add('d-none');
            
            // Create alert if it doesn't exist
            if (!document.getElementById('errorAlert')) {
                const alertDiv = document.createElement('div');
                alertDiv.id = 'errorAlert';
                alertDiv.className = 'alert alert-danger';
                alertDiv.role = 'alert';
                document.querySelector('.dashboard-container').insertBefore(
                    alertDiv, 
                    document.getElementById('loadingIndicator')
                );
            }
            
            // Update alert message
            document.getElementById('errorAlert').textContent = message;
        }

        // Handle file select for manual upload
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                document.getElementById('fileInfo').textContent = `Selected: ${file.name} (${formatFileSize(file.size)})`;
                
                // Hide any previous errors
                const errorAlert = document.getElementById('errorAlert');
                if (errorAlert) {
                    errorAlert.style.display = 'none';
                }
                
                // Load the selected file
                loadFile(file);
            }
        }
        
        // Load a manually selected file
        function loadFile(file) {
            document.getElementById('loadingIndicator').classList.remove('d-none');
            document.getElementById('dashboardContent').classList.add('d-none');
            
            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.data && results.data.length > 0) {
                        rawData = results.data;
                        initializeDashboard();
                    } else {
                        showError("No data found or file is empty.");
                    }
                },
                error: function(error) {
                    console.error("Error parsing file:", error);
                    showError("Failed to parse file. Please check the file format and try again.");
                }
            });
        }

        // Initialize the dashboard
        function initializeDashboard() {
            // Initialize filters
            populateFilterOptions();
            
            // Apply initial filters
            filteredData = [...rawData];
            
            // Update UI
            updateMetrics();
            renderCharts();
            renderTable();
            
            // Hide loading indicator and show dashboard
            document.getElementById('loadingIndicator').classList.add('d-none');
            document.getElementById('dashboardContent').classList.remove('d-none');
        }
        
        // Populate filter options
        function populateFilterOptions() {
            // Get unique values for each filter
            const plants = [...new Set(rawData.map(item => item['Plant']))].sort();
            const projects = [...new Set(rawData.map(item => item['Project'] || 'No Project'))].sort();
            const groups = [...new Set(rawData.map(item => item['Group']))].sort();
            
            // Populate plant filter
            const plantFilter = document.getElementById('plantFilter');
            plantFilter.innerHTML = '';
            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.textContent = 'All Plants';
            plantFilter.appendChild(allOption);
            plants.forEach(plant => {
                const option = document.createElement('option');
                option.value = plant;
                option.textContent = plant;
                plantFilter.appendChild(option);
            });
            
            // Populate project filter
            const projectFilter = document.getElementById('projectFilter');
            projectFilter.innerHTML = '';
            const allProjectOption = document.createElement('option');
            allProjectOption.value = 'all';
            allProjectOption.textContent = 'All Projects';
            projectFilter.appendChild(allProjectOption);
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project;
                option.textContent = project;
                projectFilter.appendChild(option);
            });
            
            // Populate group filter
            const groupFilter = document.getElementById('groupFilter');
            groupFilter.innerHTML = '';
            const allGroupOption = document.createElement('option');
            allGroupOption.value = 'all';
            allGroupOption.textContent = 'All Groups';
            groupFilter.appendChild(allGroupOption);
            groups.forEach(group => {
                if (group) {
                    const option = document.createElement('option');
                    option.value = group;
                    option.textContent = group;
                    groupFilter.appendChild(option);
                }
            });
        }
        
        // Apply filters
        function applyFilters() {
            const plant = document.getElementById('plantFilter').value;
            const project = document.getElementById('projectFilter').value;
            const category = document.getElementById('categoryFilter').value;
            const group = document.getElementById('groupFilter').value;
            
            filteredData = rawData.filter(item => {
                return (plant === 'all' || item['Plant'] === plant) &&
                       (project === 'all' || (item['Project'] || 'No Project') === project) &&
                       (category === 'all' || item['FG/SFG/RM'] === category) &&
                       (group === 'all' || item['Group'] === group);
            });
            
            // Reset to first page
            currentPage = 1;
            
            // Update UI
            updateMetrics();
            renderCharts();
            renderTable();
        }
        
        // Reset filters
        function resetFilters() {
            document.getElementById('plantFilter').value = 'all';
            document.getElementById('projectFilter').value = 'all';
            document.getElementById('categoryFilter').value = 'all';
            document.getElementById('groupFilter').value = 'all';
            
            filteredData = [...rawData];
            currentPage = 1;
            
            // Update UI
            updateMetrics();
            renderCharts();
            renderTable();
        }
        
        // Update metrics
        function updateMetrics() {
            // Calculate totals
            let totalValue = 0;
            let wipValue = 0;
            let whValue = 0;
            
            filteredData.forEach(item => {
                totalValue += parseFloat(item['Total COGS'] || 0);
                wipValue += parseFloat(item['WIP_Value'] || 0);
                whValue += parseFloat(item['WH_Value'] || 0);
            });
            
            // Update UI
            document.getElementById('totalInventoryValue').textContent = formatCurrency(totalValue);
            document.getElementById('wipValue').textContent = formatCurrency(wipValue);
            document.getElementById('whValue').textContent = formatCurrency(whValue);
            document.getElementById('itemCount').textContent = filteredData.length;
        }
        
        // Format currency
        function formatCurrency(value) {
            return '$' + value.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }
        
        // Render charts
        function renderCharts() {
            // Destroy existing charts
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            
            // Render new charts
            renderCategoryChart();
            renderProjectChart();
            renderLocationChart();
            renderTopItemsChart();
        }
        
        // Render category chart
        function renderCategoryChart() {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            
            // Group data by category
            const categoryData = {};
            filteredData.forEach(item => {
                const category = item['FG/SFG/RM'] || 'Unknown';
                if (!categoryData[category]) {
                    categoryData[category] = 0;
                }
                categoryData[category] += parseFloat(item['Total COGS'] || 0);
            });
            
            // Prepare chart data
            const labels = Object.keys(categoryData);
            const data = Object.values(categoryData);
            const backgroundColors = [
                'rgba(54, 162, 235, 0.7)',
                'rgba(255, 99, 132, 0.7)',
                'rgba(255, 206, 86, 0.7)',
                'rgba(75, 192, 192, 0.7)'
            ];
            
            charts.categoryChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const percentage = ((value / data.reduce((a, b) => a + b, 0)) * 100).toFixed(1);
                                    return `${context.label}: ${formatCurrency(value)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Render project chart
        function renderProjectChart() {
            const ctx = document.getElementById('projectChart').getContext('2d');
            
            // Group data by project
            const projectData = {};
            filteredData.forEach(item => {
                const project = item['Project'] || 'No Project';
                if (!projectData[project]) {
                    projectData[project] = 0;
                }
                projectData[project] += parseFloat(item['Total COGS'] || 0);
            });
            
            // Sort projects by value and take top 10
            const sortedProjects = Object.entries(projectData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            // Prepare chart data
            const labels = sortedProjects.map(item => item[0]);
            const data = sortedProjects.map(item => item[1]);
            
            charts.projectChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Inventory Value',
                        data: data,
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Value: ' + formatCurrency(context.raw);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Render location chart
        function renderLocationChart() {
            const ctx = document.getElementById('locationChart').getContext('2d');
            
            // Calculate totals by location
            let whTotal = 0;
            let wipTotal = 0;
            let exlpickTotal = 0;
            
            filteredData.forEach(item => {
                whTotal += parseFloat(item['WH_Value'] || 0);
                wipTotal += parseFloat(item['WIP_Value'] || 0);
                exlpickTotal += parseFloat(item['EXLPICK_Value'] || 0);
            });
            
            charts.locationChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Warehouse', 'WIP', 'EXLPICK'],
                    datasets: [{
                        data: [whTotal, wipTotal, exlpickTotal],
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(255, 206, 86, 0.7)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = whTotal + wipTotal + exlpickTotal;
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: ${formatCurrency(value)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Render top items chart
        function renderTopItemsChart() {
            const ctx = document.getElementById('topItemsChart').getContext('2d');
            
            // Sort items by total value and take top 10
            const topItems = [...filteredData]
                .sort((a, b) => parseFloat(b['Total COGS'] || 0) - parseFloat(a['Total COGS'] || 0))
                .slice(0, 10);
            
            // Prepare chart data
            const labels = topItems.map(item => item['Item Number']);
            const data = topItems.map(item => parseFloat(item['Total COGS'] || 0));
            
            charts.topItemsChart = new Chart(ctx, {
                type: 'horizontalBar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Inventory Value',
                        data: data,
                        backgroundColor: 'rgba(153, 102, 255, 0.7)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const item = topItems[context.dataIndex];
                                    return [
                                        'Value: ' + formatCurrency(context.raw),
                                        'Description: ' + (item['Item Description'] || 'N/A')
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Render table
        function renderTable() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            // Calculate pagination
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = Math.min(startIndex + rowsPerPage, filteredData.length);
            const pageData = filteredData.slice(startIndex, endIndex);
            
            // Render table rows
            pageData.forEach(item => {
                const row = document.createElement('tr');
                
                // Add cells
                row.innerHTML = `
                    <td>${item['Plant'] || ''}</td>
                    <td>${item['Project'] || 'No Project'}</td>
                    <td>${item['FG/SFG/RM'] || ''}</td>
                    <td>${item['Item Number'] || ''}</td>
                    <td>${item['Item Description'] || ''}</td>
                    <td>${formatNumber(item['WIP_Qty'] || 0)}</td>
                    <td>${formatNumber(item['WH_Qty'] || 0)}</td>
                    <td>${formatCurrency(item['WIP_Value'] || 0)}</td>
                    <td>${formatCurrency(item['WH_Value'] || 0)}</td>
                    <td>${formatCurrency(item['Total COGS'] || 0)}</td>
                `;
                
                tableBody.appendChild(row);
            });
            
            // Update pagination info
            updatePaginationInfo();
        }
        
        // Format number
        function formatNumber(value) {
            return parseFloat(value).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }
        
        // Update pagination info
        function updatePaginationInfo() {
            const startIndex = (currentPage - 1) * rowsPerPage + 1;
            const endIndex = Math.min(startIndex + rowsPerPage - 1, filteredData.length);
            
            document.getElementById('pageInfo').textContent = `Showing ${startIndex}-${endIndex} of ${filteredData.length} items`;
            
            // Update button states
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = endIndex >= filteredData.length;
        }
        
        // Navigate to page
        function navigateToPage(page) {
            if (page < 1 || page > Math.ceil(filteredData.length / rowsPerPage)) {
                return;
            }
            
            currentPage = page;
            renderTable();
        }
        
        // Export to CSV
        function exportToCSV() {
            if (filteredData.length === 0) {
                alert('No data to export.');
                return;
            }
            
            // Create CSV content
            const headers = [
                'Plant', 'Project', 'Category', 'Item Number', 'Description',
                'WIP Qty', 'WH Qty', 'WIP Value', 'WH Value', 'Total Value'
            ];
            
            let csvContent = headers.join(',') + '\n';
            
            filteredData.forEach(item => {
                const row = [
                    item['Plant'] || '',
                    (item['Project'] || 'No Project').replace(/,/g, ' '),
                    item['FG/SFG/RM'] || '',
                    item['Item Number'] || '',
                    (item['Item Description'] || '').replace(/,/g, ' '),
                    item['WIP_Qty'] || 0,
                    item['WH_Qty'] || 0,
                    item['WIP_Value'] || 0,
                    item['WH_Value'] || 0,
                    item['Total COGS'] || 0
                ];
                
                csvContent += row.join(',') + '\n';
            });
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'inventory_data_export.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>
